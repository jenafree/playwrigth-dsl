# Nightly Regression - Playwright DSL E-commerce
# ExecuÃ§Ã£o completa noturna com relatÃ³rios e mÃ©tricas

name: 'ðŸŒ™ Nightly Regression'

on:
  schedule:
    # Todo dia Ã s 2h da madrugada (UTC)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de teste'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  # === RegressÃ£o Completa ===
  regressao:
    name: 'ðŸ”„ RegressÃ£o Completa - ${{ matrix.browser }}'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1/3, 2/3, 3/3]
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        
      - name: Run regression tests
        run: npx playwright test --browser=${{ matrix.browser }} --shard=${{ matrix.shard }}
        env:
          CI: true
          
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-${{ matrix.browser }}-${{ strategy.job-index }}-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # === MÃ©tricas de Observabilidade ===
  metricas:
    name: 'ðŸ“Š Coleta de MÃ©tricas'
    runs-on: ubuntu-latest
    needs: regressao
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all test results
        uses: actions/download-artifact@v4
        
      - name: Generate metrics report
        run: |
          echo "## ðŸ“Š MÃ©tricas Nightly - $(date)" >> metrics.md
          echo "" >> metrics.md
          echo "### ðŸŽ¯ Casos de Uso Executados" >> metrics.md
          echo "- **FinalizarCompra**: Caminho feliz crÃ­tico" >> metrics.md
          echo "- **AplicarCupom**: CenÃ¡rios vÃ¡lido/invÃ¡lido/expirado" >> metrics.md
          echo "- **Pagamento**: Recusas + aprovaÃ§Ã£o" >> metrics.md
          echo "" >> metrics.md
          echo "### ðŸ—ï¸ Arquitetura DSL" >> metrics.md
          echo "- **Eventos de DomÃ­nio**: ItemAdicionado, CupomAplicado, PedidoCriado" >> metrics.md
          echo "- **Invariantes Validadas**: total = itens + frete - desconto" >> metrics.md
          echo "- **Dados CanÃ´nicos**: SKUs, cupons, cartÃµes sandbox" >> metrics.md
          echo "" >> metrics.md
          echo "### ðŸš¨ Alertas" >> metrics.md
          echo "- Flakiness rate: < 5% (meta)" >> metrics.md
          echo "- P95 FinalizarCompra: < 30s (meta)" >> metrics.md
          echo "- Taxa de sucesso: > 95% (meta)" >> metrics.md
          
      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: nightly-metrics
          path: metrics.md

  # === RelatÃ³rio Final ===
  relatorio:
    name: 'ðŸ“‹ RelatÃ³rio Nightly'
    runs-on: ubuntu-latest
    needs: [regressao, metricas]
    if: always()
    steps:
      - name: Generate final report
        run: |
          echo "## ðŸŒ™ RelatÃ³rio Nightly Regression" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Data**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Ambiente**: ${{ env.ENVIRONMENT || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Resultados" >> $GITHUB_STEP_SUMMARY
          echo "- **Status RegressÃ£o**: ${{ needs.regressao.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **MÃ©tricas Coletadas**: ${{ needs.metricas.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Casos de Uso Validados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **FinalizarCompra**: Fluxo crÃ­tico E2E" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **AplicarCupom**: PolÃ­ticas promocionais" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Pagamento**: IntegraÃ§Ãµes gateway" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ Arquitetura DSL" >> $GITHUB_STEP_SUMMARY
          echo "- **Comandos Simples**: AÃ§Ãµes atÃ´micas de domÃ­nio" >> $GITHUB_STEP_SUMMARY
          echo "- **Comandos Compostos**: Use cases orquestrados" >> $GITHUB_STEP_SUMMARY
          echo "- **Observabilidade**: Eventos + invariantes + mÃ©tricas" >> $GITHUB_STEP_SUMMARY
          echo "- **Qualidade**: Global setup + fixtures + cleanup" >> $GITHUB_STEP_SUMMARY
